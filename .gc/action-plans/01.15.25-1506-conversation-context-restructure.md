# Conversation Context Restructure - Turn-Based System

**STATUS: READY FOR IMMEDIATE IMPLEMENTATION** 
OpenAI integration has been fully tested with multiple scenarios and word constraints. All prerequisites are met, making this the highest priority task remaining.

## Overall Goal
Restructure the AI server's conversation context system to use a turn-based approach that:
1. Maintains proper AI immersion (AI doesn't know insider is guessing)
2. Tracks conversation chronologically by character turns
3. Keeps AI server stateless while game server manages context
4. Separates insider's private guesses from public conversation

## Regression Risk Analysis
**Low Risk Changes:**
- Type definitions are additive, won't break existing code
- AI service method signature change is contained to AI server

**Medium Risk Changes:**
- Route handler input validation needs updating
- Conversation history mapping logic completely changes

**Mitigation Recommendations:**
- Update type definitions first
- Test AI service in isolation before integrating
- Maintain backward compatibility during transition
- Validate new schema thoroughly

## Action Items

### 1. Update Type Definitions
**File:** `backend/openai/types/game.ts`
- Remove existing `MessageSchema` and related types
- Add new `ContextAddition` union type with three variants:
  - `{ type: 'outsider', message: string }`
  - `{ type: 'ai', thinking: string[], guess: string, suspicionLevel: number }`
  - `{ type: 'insider', message: string }`
- Update `AnalyzeRequestSchema` to use array of `ContextAddition` instead of `Message[]`
- Keep `AIResponseSchema` unchanged (still returns thinking, guess, suspicionLevel)

### 2. Refactor OpenAI Service Context Mapping
**File:** `backend/openai/services/openai.ts`
- Remove `mapRoleForAI` function (role mapping now handled in context structure)
- Remove regex-based suspicion level extraction logic
- Update `analyzeConversation` method parameter from `Message[]` to `ContextAddition[]`
- Rewrite conversation history mapping logic:
  - For `outsider` context: map to user message with "Marcus_Chen_ID7429"
  - For `insider` context: map to user message with "Sarah_Chen_Personal_Contact" 
  - For `ai` context: map to assistant message with full analysis + suspicion level
- Update system prompt injection to use new context structure

### 3. Update Route Handler Validation
**File:** `backend/openai/routes/ai.ts`
- Update request validation to use new `AnalyzeRequestSchema`
- Ensure error handling covers new context structure validation
- Update response metadata calculation (still count total context additions)

### 4. Update Main Server Integration
**File:** `backend/openai/index.ts`
- No changes required (routes handle the interface changes)

## Implementation Notes

### AI Immersion Preservation
- Outsider messages appear as normal domestic communication from oil rig worker
- Insider messages appear as normal responses from worker's wife
- AI never sees insider's private guesses, only their conversation messages
- Previous AI analysis with suspicion levels gets injected as assistant messages

### Context Building Flow
1. Game server collects all character turns chronologically
2. Builds array of `ContextAddition` objects
3. Passes complete history to AI server via POST `/api/ai/analyze`
4. AI server processes context and returns analysis
5. Game server adds AI's response to context for next analysis

### Validation Strategy
- Create mock context data with multiple turns
- Test AI service with various suspicion level progressions
- Verify AI immersion (no knowledge of insider guessing)
- Ensure chronological ordering is preserved

## Success Criteria
- AI server accepts new context structure
- AI maintains proper immersion (sees domestic conversation)
- Suspicion levels build properly over multiple turns
- Game server can pass complete conversation history
- No regression in AI response quality or schema compliance

## Current Implementation Issues
**PROBLEMS WITH CURRENT APPROACH**: The current `Message[]` schema has critical flaws:
- ❌ Regex parsing for suspicion levels is unreliable and brittle
- ❌ Context management is hacky and error-prone
- ❌ AI messages mixed with user messages makes history confusing
- ❌ No clear separation between conversation turns
- ❌ Difficult to maintain suspicion level progression

**RECOMMENDED IMPLEMENTATION PRIORITY**: This should be implemented now because:
- **Reliability**: Current regex parsing will fail with varied AI responses
- **Maintainability**: Structured context is much easier to debug and extend  
- **AI Performance**: Clear turn-based context improves AI reasoning
- **Data Integrity**: Proper typing prevents runtime errors

## Prerequisites for Implementation
✅ 1. **Update OpenAI Service**: Migrated to structured outputs
✅ 2. **Fix Environment**: OpenAI API key configuration working
✅ 3. **Test Current Schema**: Validated basic Message[] flow works with multiple scenarios
⏳ 4. **Implement**: Ready for turn-based context structure implementation

## Implementation Order
✅ 1. Fix OpenAI structured outputs (completed)
✅ 2. Fix environment setup and configuration
✅ 3. Test basic functionality with current schema
⏳ 4. Implement this turn-based context structure 
⏳ 5. Test and validate improved context management

## Additional Validations Completed
- ✅ Tested with varying suspicion levels (10%, 30%, 70%)
- ✅ Verified proper word constraints (3-12 chars, lowercase)
- ✅ Confirmed consistent response structure
- ✅ Validated thinking sentence length limits
- ✅ Tested error handling and validation

## Error Handling Strategy
**Types of Errors to Handle:**
1. **Invalid Context Structure**
   - Empty context array
   - Missing required fields in context objects
   - Invalid message ordering (non-chronological)

2. **AI Analysis Continuity**
   - Missing previous AI analysis in context
   - Inconsistent suspicion level progression
   - Duplicate AI analyses for same turn

3. **Message Content Validation**
   - Empty messages
   - Messages exceeding reasonable length
   - Invalid character encodings

**Error Response Format:**
```typescript
{
  error: string;          // Human-readable error message
  code: string;          // Error code for client handling
  details?: unknown;     // Additional error context if needed
  validationErrors?: {   // For Zod validation failures
    field: string;
    message: string;
  }[];
}
```

## Enhanced Testing Strategy
**1. Context Building Tests**
- Test chronological message ordering
- Validate context object structure
- Verify AI analysis inclusion

**2. Turn Progression Tests**
```typescript
const turnProgressionTest = [
  // Turn 1
  { type: 'outsider', message: 'Initial message' },
  // AI Analysis 1
  { type: 'ai', thinking: [...], guess: 'word', suspicionLevel: 20 },
  // Turn 2
  { type: 'insider', message: 'Response message' },
  // AI Analysis 2 - should show progression
  { type: 'ai', thinking: [...], guess: 'another', suspicionLevel: 40 }
];
```

**3. Edge Cases**
- Empty messages in context
- Very long conversation histories
- Messages with special characters
- Rapid turn sequences

**4. Error Case Tests**
- Invalid context structure
- Missing AI analysis
- Non-chronological messages
- Malformed message content

## Next Steps
1. Begin type definition updates (lowest risk change)
2. Implement new context mapping without regex
3. Add error handling for identified cases
4. Update route handler validation
5. Implement test scenarios with new structure
6. Validate error responses 
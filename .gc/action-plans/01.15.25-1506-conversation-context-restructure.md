# Conversation Context Restructure - Turn-Based System

**STATUS: READY FOR IMMEDIATE IMPLEMENTATION** 
OpenAI integration has been fully tested with multiple scenarios and word constraints. All prerequisites are met, making this the highest priority task remaining.

## Overall Goal
Restructure the AI server's conversation context system to use a turn-based approach that:
1. Maintains proper AI immersion (AI doesn't know insider is guessing)
2. Tracks conversation chronologically by character turns
3. Keeps AI server stateless while game server manages context
4. Separates insider's private guesses from public conversation

## Regression Risk Analysis
**Low Risk Changes:**
- Type definitions are additive, won't break existing code
- AI service method signature change is contained to AI server

**Medium Risk Changes:**
- Route handler input validation needs updating
- Conversation history mapping logic completely changes

**Mitigation Recommendations:**
- Update type definitions first
- Test AI service in isolation before integrating
- Maintain backward compatibility during transition
- Validate new schema thoroughly

## Action Items

### 1. Update Type Definitions ‚úÖ
**File:** `backend/openai/types/game.ts`
- ‚úÖ Remove existing `MessageSchema` (marked as @deprecated)
- ‚úÖ Add new turn-based structure with JSDoc documentation:
  ```typescript
  /**
   * A single turn in the conversation.
   * Each turn represents a complete action by one participant.
   * 
   * Turn Completion Rules:
   * - Outsider turn: Complete when they send their message
   * - AI turn: Complete when we have thinking, guess, AND suspicion level
   * - Insider turn: Complete when they guess + send message (if wrong)
   */
  type Turn = {
    turnNumber: number;
    timestamp: Date;
    context: ContextAddition;
  }
  ```
- ‚úÖ Add turn validation:
  - Sequential turn numbers
  - No consecutive turns by same participant
  - Current turn matches array length
- ‚úÖ Add example usage in JSDoc for developer guidance

### 2. Refactor OpenAI Service Context Mapping ‚úÖ
**File:** `backend/openai/services/openai.ts`
- ‚úÖ Remove `mapRoleForAI` function (role mapping now handled in context structure)
- ‚úÖ Remove regex-based suspicion level extraction logic
- ‚úÖ Update `analyzeConversation` method to use turn-based structure:
  ```typescript
  async analyzeConversation(turns: Turn[]): Promise<AIResponse>
  ```
- ‚úÖ Simplified message handling:
  - All conversation history sent as single user message
  - Clear labeling with [WORKER], [SPOUSE], [ANALYSIS] prefixes
  - Structured formatting of AI analysis
- ‚úÖ Update system prompt to reflect turn-based conversation

Key improvements made:
1. Removed unnecessary role mapping complexity
2. Treating all conversation history as user content
3. Clearer message labeling for AI context
4. More maintainable and reliable parsing

### 3. Update Route Handler Validation ‚è≥
**File:** `backend/openai/routes/ai.ts`
- Update request validation to use new turn-based schema
- Add turn sequence validation
- Update response metadata to include turn information
- Add error handling for turn validation failures

### 4. Update Main Server Integration
**File:** `backend/openai/index.ts`
- No changes required (routes handle the interface changes)

## Implementation Notes

### Turn-Based Flow
1. Game server collects turns chronologically
2. Each turn represents ONE complete action:
   ```typescript
   // Example turn sequence:
   const turns = [
     // Turn 1: Outsider's message
     { 
       turnNumber: 1,
       timestamp: new Date(),
       context: { type: 'outsider', message: "Hey honey!" }
     },
     
     // Turn 2: AI's complete analysis
     {
       turnNumber: 2,
       timestamp: new Date(),
       context: {
         type: 'ai',
         thinking: ["Analyzing patterns...", ...],
         guess: "garden",
         suspicionLevel: 30
       }
     },
     
     // Turn 3: Insider's wrong guess + message
     {
       turnNumber: 3,
       timestamp: new Date(),
       context: { type: 'insider', message: "How are things?" }
     }
   ];
   ```
3. Each turn is only added when ALL required actions are complete
4. Turn validation ensures proper sequence and completeness

### Turn Completion Criteria
- **Outsider**: Message sent
- **AI**: All three outputs generated (thinking, guess, suspicion)
- **Insider**: 
  1. Makes guess
  2. If wrong ‚Üí sends message
  3. If correct ‚Üí game ends

### AI Immersion Preservation
- Outsider messages appear as normal domestic communication from oil rig worker
- Insider messages appear as normal responses from worker's wife
- AI never sees insider's private guesses, only their conversation messages
- Previous AI analysis with suspicion levels gets injected as assistant messages

### Context Building Flow
1. Game server collects all character turns chronologically
2. Builds array of `ContextAddition` objects using discriminated union types:
   ```typescript
   const context: ContextAddition[] = [
     { type: 'outsider', message: "Hey honey, just checking the garden." },
     { type: 'insider', message: "How are the tomatoes doing?" },
     { 
       type: 'ai', 
       thinking: ["Message seems casual...", "..."], 
       guess: "tomatoes",
       suspicionLevel: 30 
     }
   ];
   ```
3. Passes complete history to AI server via POST `/api/ai/analyze`
4. AI server processes context and returns analysis
5. Game server adds AI's response to context for next analysis

### Validation Strategy
- Create mock context data with multiple turns
- Test AI service with various suspicion level progressions
- Verify AI immersion (no knowledge of insider guessing)
- Ensure chronological ordering is preserved

## Success Criteria
- AI server accepts new context structure
- AI maintains proper immersion (sees domestic conversation)
- Suspicion levels build properly over multiple turns
- Game server can pass complete conversation history
- No regression in AI response quality or schema compliance

## Current Implementation Issues
**SOLVED PROBLEMS**:
- ‚úÖ Replaced regex parsing with structured turn data
- ‚úÖ Added clear rules for turn completion
- ‚úÖ Implemented turn sequence validation
- ‚úÖ Added JSDoc documentation for developer guidance
- ‚úÖ Defined chronological turn tracking

**REMAINING ISSUES**:
- ‚úÖ OpenAI service now uses Turn[] format with simplified context
- ‚è≥ Route handlers need updating for new turn structure
- ‚è≥ Need to implement turn validation in practice
- ‚è≥ Need to test turn-based flow with real scenarios

**SOLUTIONS IN PROGRESS**:
- ‚úÖ Refactored OpenAI service to use Turn[] with simplified context
- üîÑ Updating route handlers to validate turn sequence
- üîÑ Adding integration tests for turn-based flow
- üîÑ Implementing real-time turn validation

## Prerequisites for Implementation
‚úÖ 1. **Update OpenAI Service**: Migrated to structured outputs
‚úÖ 2. **Fix Environment**: OpenAI API key configuration working
‚úÖ 3. **Test Current Schema**: Validated basic Message[] flow works with multiple scenarios
‚úÖ 4. **Implement**: Completed turn-based context structure implementation

## Implementation Order
‚úÖ 1. Fix OpenAI structured outputs (completed)
‚úÖ 2. Fix environment setup and configuration
‚úÖ 3. Test basic functionality with current schema
‚úÖ 4. Implement type definitions for turn-based context
‚úÖ 5. Refactor OpenAI service to use new types with simplified context
‚è≥ 6. Update route handlers and validation
‚è≥ 7. Test and validate improved context management

## Additional Validations Completed
- ‚úÖ Tested with varying suspicion levels (10%, 30%, 70%)
- ‚úÖ Verified proper word constraints (3-12 chars, lowercase)
- ‚úÖ Confirmed consistent response structure
- ‚úÖ Validated thinking sentence length limits
- ‚úÖ Tested error handling and validation

## Error Handling Strategy
**Types of Errors to Handle:**
1. **Invalid Context Structure**
   - Empty context array
   - Missing required fields in context objects
   - Invalid message ordering (non-chronological)

2. **AI Analysis Continuity**
   - Missing previous AI analysis in context
   - Inconsistent suspicion level progression
   - Duplicate AI analyses for same turn

3. **Message Content Validation**
   - Empty messages
   - Messages exceeding reasonable length
   - Invalid character encodings

**Error Response Format:**
```typescript
{
  error: string;          // Human-readable error message
  code: string;          // Error code for client handling
  details?: unknown;     // Additional error context if needed
  validationErrors?: {   // For Zod validation failures
    field: string;
    message: string;
  }[];
}
```

## Enhanced Testing Strategy
**1. Context Building Tests**
- Test chronological message ordering
- Validate context object structure
- Verify AI analysis inclusion

**2. Turn Progression Tests**
```typescript
const turnProgressionTest = [
  // Turn 1
  { type: 'outsider', message: 'Initial message' },
  // AI Analysis 1
  { type: 'ai', thinking: [...], guess: 'word', suspicionLevel: 20 },
  // Turn 2
  { type: 'insider', message: 'Response message' },
  // AI Analysis 2 - should show progression
  { type: 'ai', thinking: [...], guess: 'another', suspicionLevel: 40 }
];
```

**3. Edge Cases**
- Empty messages in context
- Very long conversation histories
- Messages with special characters
- Rapid turn sequences

**4. Error Case Tests**
- Invalid context structure
- Missing AI analysis
- Non-chronological messages
- Malformed message content

## Next Steps
1. Begin type definition updates (lowest risk change)
2. Implement new context mapping without regex
3. Add error handling for identified cases
4. Update route handler validation
5. Implement test scenarios with new structure
6. Validate error responses 
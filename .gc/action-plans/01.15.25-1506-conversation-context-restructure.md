# Conversation Context Restructure - Turn-Based System

**STATUS: IMPLEMENTATION IN PROGRESS** 
Core schema defined, OpenAI integration tested, route handlers being updated.

## Overall Goal
Implement a simplified turn-based game flow that:
1. Maintains clear sequence: outsider → ai → insider → ai
2. Tracks conversation chronologically
3. Keeps game state management simple
4. Records failed guesses for AI context

## Implementation Status

### ✅ Completed
1. **Type Definitions** (`backend/openai/types/game.ts`)
   ```typescript
   type Turn = 
     | OutsiderTurn  // hint message + turn number
     | AITurn        // thinking + guess + turn number
     | InsiderTurn   // guess + turn number
   ```

2. **OpenAI Service** (`backend/openai/services/openai.ts`)
   - Simplified context as single user message
   - Removed complex role mapping
   - Clear turn sequence validation

3. **Game Flow**
   - Outsider sends hint → AI analyzes
   - If AI correct → Game Over
   - If AI wrong → Insider guesses
   - If Insider correct → Game Over
   - If Insider wrong → Add to history

### ⏳ Critical Files Needing Updates

#### 1. **Route Handler** (`backend/openai/routes/ai.ts`) - HIGH PRIORITY
**Current Issues:**
- Expects old `Message[]` format in `AnalyzeRequestSchema.parse(req.body)`
- Response includes deprecated `metadata` field
- Error handling references old schema

**Required Changes:**
- Update to use new `Turn[]` format with `gameId`
- Remove metadata from response (suspicion level removed)
- Update error handling for turn validation
- Add game end condition logic

#### 2. **OpenAI Service** (`backend/openai/services/openai.ts`) - CRITICAL
**Current Issues:**
- Still references old `context.type: 'outsider'/'insider'/'ai'` format
- Includes `suspicionLevel` in response (removed from new schema)
- Uses old context structure in conversation formatting

**Required Changes:**
- Update turn processing to use new types: `'outsider_hint'`, `'ai_analysis'`, `'insider_guess'`
- Remove `suspicionLevel` from tool definition and response
- Update conversation formatting for new turn types
- Update system prompt to remove storytelling elements

#### 3. **Test File** (`backend/openai/test-openai.ts`) - MEDIUM PRIORITY
**Current Issues:**
- Uses old `Message[]` format with `role` and `type` fields
- Tests expect `suspicionLevel` in response
- Mock data doesn't match new turn structure

**Required Changes:**
- Convert test scenarios to new `Turn[]` format
- Remove suspicion level from test validations
- Update mock data to use new turn types
- Add tests for turn sequence validation

#### 4. **Game Handlers** (`backend/src/socket/handlers/gameHandlers.ts`) - HIGH PRIORITY
**Current Issues:**
- Uses `MockAIService` instead of real OpenAI service
- Expects old AI response format with `confidence` field
- Game state uses old `Message[]` and `AIGuess[]` structures
- Turn management uses old roles ('encryptor'/'decryptor' vs 'outsider'/'insider')

**Required Changes:**
- Switch from `MockAIService` to real OpenAI service
- Update AI response handling to new format (no confidence/suspicion)
- Convert game state to use `Turn[]` format
- Update role mapping: encryptor→outsider, decryptor→insider
- Implement new game end conditions (AI or insider guesses correctly)
- Remove complex game state persistence (keep it simple)

#### 5. **Main Game Types** (`backend/src/types/index.ts`) - HIGH PRIORITY
**Current Issues:**
- `GameState` uses old `Message[]` and `AIGuess[]` arrays
- Player roles are 'encryptor'/'decryptor' instead of 'outsider'/'insider'
- Complex game state structure not needed for simplified game

**Required Changes:**
- Update `GameState` to use single `Turn[]` array
- Change player roles to 'outsider'/'insider'
- Simplify game state (remove unnecessary fields)
- Add game end conditions
- Update interfaces for new flow

#### 6. **Mock AI Service** (`backend/src/ai/mock.ts`) - LOW PRIORITY (REMOVE)
**Current Issues:**
- No longer needed since we're using real OpenAI service
- Interface doesn't match new schema
- Adds unnecessary complexity

**Required Changes:**
- Remove file entirely OR update to match new interface for fallback
- Update any imports/references

### ⏳ In Progress
1. **Route Handler Updates**
   - New request/response format
   - Turn sequence validation
   - Error handling for invalid turns

2. **Integration Testing**
   - Turn sequence validation
   - Game end conditions
   - Error cases

## Next Steps

### 1. Frontend Integration
Frontend team needs to implement:
```typescript
{
  gameId: string,
  conversationHistory: [
    {
      type: 'outsider_hint',
      content: string,
      turnNumber: number
    },
    {
      type: 'ai_analysis',
      thinking: string[4],
      guess: string,
      turnNumber: number
    },
    {
      type: 'insider_guess',
      guess: string,
      turnNumber: number
    }
  ]
}
```

Key requirements:
- Word validation (3-12 chars, lowercase)
- Track failed guesses in history
- Maintain turn sequence
- Handle game end conditions

### 2. Backend Tasks - Priority Order
1. **Update OpenAI Service** (CRITICAL) - Remove suspicion level, fix turn types
2. **Update Route Handler** (HIGH) - New schema, remove metadata
3. **Update Game Handlers** (HIGH) - Switch to real AI service, new turn flow
4. **Update Main Types** (HIGH) - New game state structure
5. **Update Test File** (MEDIUM) - New test scenarios
6. **Remove/Update Mock AI** (LOW) - Clean up unused code

### 3. Testing Strategy
Test scenarios:
1. Complete game flow:
   ```typescript
   [
     { type: 'outsider_hint', content: "grows in gardens", turnNumber: 1 },
     { type: 'ai_analysis', thinking: [...], guess: "tomato", turnNumber: 2 },
     { type: 'insider_guess', guess: "carrot", turnNumber: 3 }
   ]
   ```

2. Error cases:
   - Non-sequential turn numbers
   - Invalid turn order
   - Missing required fields
   - Invalid word lengths

3. Game end conditions:
   - AI guesses correctly
   - Insider guesses correctly
   - Multiple rounds

## Success Criteria
- ✅ Simplified game flow implemented
- ✅ Clear turn sequence enforced
- ✅ Type safety with Zod validation
- ⏳ Route handlers updated
- ⏳ Game handlers use real AI service
- ⏳ Integration tests passing
- ⏳ Frontend successfully integrated

## Critical Dependencies
1. **OpenAI Service** must be updated first (other services depend on it)
2. **Game Handlers** need new OpenAI service to work
3. **Frontend** needs final backend API to implement data collection
4. **Testing** needs all backend changes complete

## Risk Assessment
- **High Risk**: Game handlers integration (complex state management)
- **Medium Risk**: Type definition changes (affects multiple files)
- **Low Risk**: Route handler updates (isolated changes) 
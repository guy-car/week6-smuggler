# Conversation Context Restructure - Turn-Based System

## Overall Goal
Restructure the AI server's conversation context system to use a turn-based approach that:
1. Maintains proper AI immersion (AI doesn't know insider is guessing)
2. Tracks conversation chronologically by character turns
3. Keeps AI server stateless while game server manages context
4. Separates insider's private guesses from public conversation

## Regression Risk Analysis
**Low Risk Changes:**
- Type definitions are additive, won't break existing code
- AI service method signature change is contained to AI server

**Medium Risk Changes:**
- Route handler input validation needs updating
- Conversation history mapping logic completely changes

**Mitigation Recommendations:**
- Update type definitions first
- Test AI service in isolation before integrating
- Maintain backward compatibility during transition
- Validate new schema thoroughly

## Action Items

### 1. Update Type Definitions
**File:** `backend/openai/types/game.ts`
- Remove existing `MessageSchema` and related types
- Add new `ContextAddition` union type with three variants:
  - `{ type: 'outsider', message: string }`
  - `{ type: 'ai', thinking: string[], guess: string, suspicionLevel: number }`
  - `{ type: 'insider', message: string }`
- Update `AnalyzeRequestSchema` to use array of `ContextAddition` instead of `Message[]`
- Keep `AIResponseSchema` unchanged (still returns thinking, guess, suspicionLevel)

### 2. Refactor OpenAI Service Context Mapping
**File:** `backend/openai/services/openai.ts`
- Remove `mapRoleForAI` function (role mapping now handled in context structure)
- Remove regex-based suspicion level extraction logic
- Update `analyzeConversation` method parameter from `Message[]` to `ContextAddition[]`
- Rewrite conversation history mapping logic:
  - For `outsider` context: map to user message with "Marcus_Chen_ID7429"
  - For `insider` context: map to user message with "Sarah_Chen_Personal_Contact" 
  - For `ai` context: map to assistant message with full analysis + suspicion level
- Update system prompt injection to use new context structure

### 3. Update Route Handler Validation
**File:** `backend/openai/routes/ai.ts`
- Update request validation to use new `AnalyzeRequestSchema`
- Ensure error handling covers new context structure validation
- Update response metadata calculation (still count total context additions)

### 4. Update Main Server Integration
**File:** `backend/openai/index.ts`
- No changes required (routes handle the interface changes)

## Implementation Notes

### AI Immersion Preservation
- Outsider messages appear as normal domestic communication from oil rig worker
- Insider messages appear as normal responses from worker's wife
- AI never sees insider's private guesses, only their conversation messages
- Previous AI analysis with suspicion levels gets injected as assistant messages

### Context Building Flow
1. Game server collects all character turns chronologically
2. Builds array of `ContextAddition` objects
3. Passes complete history to AI server via POST `/api/ai/analyze`
4. AI server processes context and returns analysis
5. Game server adds AI's response to context for next analysis

### Validation Strategy
- Create mock context data with multiple turns
- Test AI service with various suspicion level progressions
- Verify AI immersion (no knowledge of insider guessing)
- Ensure chronological ordering is preserved

## Success Criteria
- AI server accepts new context structure
- AI maintains proper immersion (sees domestic conversation)
- Suspicion levels build properly over multiple turns
- Game server can pass complete conversation history
- No regression in AI response quality or schema compliance 